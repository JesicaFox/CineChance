<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–æ–≤ –∏ –∞–Ω–∏–º–µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-white p-8">
    <div class="max-w-4xl mx-auto space-y-6">
        <h1 class="text-2xl font-bold">–¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–æ–≤ –∏ –∞–Ω–∏–º–µ</h1>
        
        <div id="loading" class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        
        <div id="results" class="space-y-4 hidden">
            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div id="totalStats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
            
            <!-- –¢–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">–¢–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h2>
                <div id="typeBreakdown" class="space-y-2"></div>
            </div>
            
            <!-- Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <pre id="debugInfo" class="text-xs text-gray-400 overflow-x-auto"></pre>
            </div>
            
            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞–ø–∏—Å—è–º -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞–ø–∏—Å—è–º</h2>
                <div id="detailedRecords" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
        
        <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
            –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>

    <script>
        async function fetchStats() {
            try {
                console.log('=== –ó–ê–ü–†–û–° –°–¢–ê–¢–ò–°–¢–ò–ö–ò ===');
                const response = await fetch('/api/user/stats');
                const data = await response.json();
                
                console.log('–û—Ç–≤–µ—Ç API:', data);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const totalStats = document.getElementById('totalStats');
                totalStats.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400">${data.total?.watched || 0}</div>
                        <div class="text-sm text-gray-400">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-400">${data.total?.wantToWatch || 0}</div>
                        <div class="text-sm text-gray-400">–û—Ç–ª–æ–∂–µ–Ω–æ</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-400">${data.total?.dropped || 0}</div>
                        <div class="text-sm text-gray-400">–ë—Ä–æ—à–µ–Ω–æ</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-400">${data.total?.hidden || 0}</div>
                        <div class="text-sm text-gray-400">–°–∫—Ä—ã—Ç–æ</div>
                    </div>
                `;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                const typeBreakdown = document.getElementById('typeBreakdown');
                const total = data.total?.totalForPercentage || 1;
                typeBreakdown.innerHTML = `
                    <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                        <span>üé¨ –§–∏–ª—å–º—ã</span>
                        <span class="font-bold ${data.typeBreakdown?.movie === 0 ? 'text-red-400' : 'text-green-400'}">${data.typeBreakdown?.movie || 0}</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                        <span>üì∫ –°–µ—Ä–∏–∞–ª—ã</span>
                        <span class="font-bold ${data.typeBreakdown?.tv === 0 ? 'text-red-400' : 'text-green-400'}">${data.typeBreakdown?.tv || 0}</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                        <span>üòä –ú—É–ª—å—Ç—Ñ–∏–ª—å–º—ã</span>
                        <span class="font-bold ${data.typeBreakdown?.cartoon === 0 ? 'text-red-400' : 'text-green-400'}">${data.typeBreakdown?.cartoon || 0}</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                        <span>üå∏ –ê–Ω–∏–º–µ</span>
                        <span class="font-bold ${data.typeBreakdown?.anime === 0 ? 'text-red-400' : 'text-green-400'}">${data.typeBreakdown?.anime || 0}</span>
                    </div>
                `;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                document.getElementById('debugInfo').textContent = JSON.stringify(data.debug, null, 2);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º—É–ª—å—Ç—Ñ–∏–ª—å–º—ã –∏ –∞–Ω–∏–º–µ
                await checkSpecificContent();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('loading').innerHTML = `<div class="text-red-400">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function checkSpecificContent() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                const response = await fetch('/api/debug/stats');
                const debugData = await response.json();
                
                console.log('Debug –¥–∞–Ω–Ω—ã–µ:', debugData);
                
                const detailedRecords = document.getElementById('detailedRecords');
                detailedRecords.innerHTML = '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                if (debugData.typeAnalysis) {
                    const typeDiv = document.createElement('div');
                    typeDiv.className = 'p-3 bg-gray-800 rounded mb-3';
                    typeDiv.innerHTML = `
                        <h3 class="font-semibold text-sm mb-2">–ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–ø–µ—Ä–≤—ã–µ ${debugData.typeAnalysis.totalRecords} –∑–∞–ø–∏—Å–µ–π)</h3>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>üé¨ –§–∏–ª—å–º—ã: <span class="font-bold">${debugData.typeAnalysis.typeCounts.movie}</span></div>
                            <div>üì∫ –°–µ—Ä–∏–∞–ª—ã: <span class="font-bold">${debugData.typeAnalysis.tv}</span></div>
                            <div>üòä –ú—É–ª—å—Ç—Ñ–∏–ª—å–º—ã: <span class="font-bold text-orange-400">${debugData.typeAnalysis.typeCounts.cartoon}</span></div>
                            <div>üå∏ –ê–Ω–∏–º–µ: <span class="font-bold text-purple-400">${debugData.typeAnalysis.typeCounts.anime}</span></div>
                        </div>
                    `;
                    detailedRecords.appendChild(typeDiv);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å –∂–∞–Ω—Ä–æ–º Animation
                    if (debugData.typeAnalysis.animationContent.length > 0) {
                        const animHeader = document.createElement('div');
                        animHeader.className = 'font-semibold text-sm mb-2 text-yellow-400';
                        animHeader.textContent = `–ù–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –∂–∞–Ω—Ä–æ–º Animation: ${debugData.typeAnalysis.animationContent.length}`;
                        detailedRecords.appendChild(animHeader);
                        
                        debugData.typeAnalysis.animationContent.forEach(item => {
                            const recordDiv = document.createElement('div');
                            recordDiv.className = `p-2 bg-gray-800 rounded text-xs mb-2 ${item.finalType === 'anime' ? 'border-l-4 border-purple-500' : item.finalType === 'cartoon' ? 'border-l-4 border-orange-500' : 'border-l-4 border-gray-500'}`;
                            recordDiv.innerHTML = `
                                <div class="font-semibold">${item.title}</div>
                                <div class="text-gray-400">
                                    –¢–∏–ø: ${item.finalType} | –Ø–∑—ã–∫: ${item.original_language} | ID: ${item.tmdbId}
                                </div>
                                <div class="text-gray-500">
                                    –ñ–∞–Ω—Ä—ã: ${item.genres?.map(g => `${g.name}(${g.id})`).join(', ') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
                                </div>
                                <div class="text-gray-600">
                                    Has Animation: ${item.hasAnimationGenre} | Is Japanese: ${item.isJapanese}
                                </div>
                                ${item.tmdbError ? '<div class="text-red-400">TMDB Error</div>' : ''}
                            `;
                            detailedRecords.appendChild(recordDiv);
                        });
                    } else {
                        const noAnimDiv = document.createElement('div');
                        noAnimDiv.className = 'text-gray-400 text-sm';
                        noAnimDiv.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –∂–∞–Ω—Ä–æ–º Animation –≤ –≤—ã–±–æ—Ä–∫–µ';
                        detailedRecords.appendChild(noAnimDiv);
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                if (debugData.databaseCounts) {
                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'p-3 bg-gray-800 rounded mt-3';
                    statsDiv.innerHTML = `
                        <h3 class="font-semibold text-sm mb-2">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>–•–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å: <span class="font-bold">${debugData.databaseCounts.wantToWatch}</span></div>
                            <div>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: <span class="font-bold">${debugData.databaseCounts.watched}</span></div>
                            <div>–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–Ω–æ: <span class="font-bold">${debugData.databaseCounts.rewatched}</span></div>
                            <div>–ë—Ä–æ—à–µ–Ω–æ: <span class="font-bold">${debugData.databaseCounts.dropped}</span></div>
                        </div>
                    `;
                    detailedRecords.appendChild(statsDiv);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', error);
                document.getElementById('detailedRecords').innerHTML = `<div class="text-red-400">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        fetchStats();
    </script>
</body>
</html>
