---
phase: 09-ml-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true
requirements: []
user_setup: []

must_haves:
  truths:
    - "New ML tables exist in database"
    - "RecommendationDecision stores decision logic"
    - "ModelCorrection allows admin manual overrides"
    - "PredictionOutcome tracks user actions on recommendations"
    - "ModelTraining tracks model version and parameters"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ML tables for feedback loop"
      contains: "model RecommendationDecision"
      contains: "model ModelCorrection"
      contains: "model PredictionOutcome"
      contains: "model ModelTraining"
  key_links:
    - from: "RecommendationDecision"
      to: "PredictionOutcome"
      via: "one-to-many"
      pattern: "decision.outcomes"
    - from: "RecommendationDecision"
      to: "User"
      via: "foreign key"
      pattern: "userId"
---

<objective>
Добавить 4 таблицы в Prisma schema для ML feedback loop: RecommendationDecision, PredictionOutcome, ModelCorrection, ModelTraining
</objective>

<execution_context>
@C:/Users/n0rds/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/n0rds/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@prisma/schema.prisma
@docs/Pattern selection/0Y-Cache-Analysis.md
@docs/Pattern selection/0V-Performance-Audit.md
</context>

<tasks>

<task type="auto">
  <name>Add ML tables to schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add 4 new models to prisma/schema.prisma after existing models:

1. RecommendationDecision - stores why a recommendation was made
2. PredictionOutcome - tracks what user did with the recommendation  
3. ModelCorrection - admin manual overrides
4. ModelTraining - model version tracking

Use the exact schema from docs/Pattern selection/0Y-Cache-Analysis.md (lines 93-240).

Key fields:
- RecommendationDecision: userId, tmdbId, mediaType, finalScore, genreScore, personScore, tasteScore, wantSignalScore, genreFactors, personFactors, dropRiskFactors, filtersApplied, rejections, sourceType, similarUserId
- PredictionOutcome: decisionId, userAction (added_to_want|watched|rated|ignored|blacklisted), rating, statusAfter, wasSuccessful, confidenceMatch
- ModelCorrection: userId?, tmdbId?, mediaType?, correctionType (boost|reduce|block|reweight), targetFactor, targetValue, correctionValue, reason, adminId, isActive
- ModelTraining: modelVersion, weights, thresholds, trainingDataSize, accuracy, precision, recall, status

Add indexes for efficient queries (userId, createdAt, decisionId, correctionType, modelVersion).
  </action>
  <verify>
npx prisma generate
</verify>
  <done>
4 new models added to schema: RecommendationDecision, PredictionOutcome, ModelCorrection, ModelTraining</done>
</task>

<task type="auto">
  <name>Add relations to User model</name>
  <files>prisma/schema.prisma</files>
  <action>
Add relations to User model for the new tables:
- Add recommendationDecisions: RecommendationDecision[]
- Add modelCorrections: ModelCorrection[]
- Add predictionOutcomes: PredictionOutcome[]
- Add modelTrainings: ModelTraining[]
</action>
  <verify>
npx prisma generate
</verify>
  <done>
User model has relations to new ML tables</done>
</task>

<task type="auto">
  <name>Run migration</name>
  <files>prisma/schema.prisma</files>
  <action>
Run prisma migrate to create the new tables in the database:
npx prisma migrate dev --name add_ml_feedback_tables
</action>
  <verify>
npx prisma db push --accept-data-loss
</verify>
  <done>
Tables created in database</done>
</task>

</tasks>

<verification>
- [ ] npx prisma generate succeeds
- [ ] npx prisma migrate creates tables
- [ ] All 4 new tables exist in database
- [ ] User model has relations to new tables
</verification>

<success_criteria>
4 new ML tables added: RecommendationDecision, PredictionOutcome, ModelCorrection, ModelTraining
</success_criteria>

<output>
After completion, create `.planning/phases/09-ml-schema/09-01-SUMMARY.md`
</output>
