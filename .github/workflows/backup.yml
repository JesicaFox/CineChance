name: Test Yandex Disk

on:
  workflow_dispatch

jobs:
  test-yandex-disk:
    runs-on: ubuntu-latest

    steps:
      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for Yandex Disk
        run: |
          mkdir -p ~/.config/rclone

          # Сначала "замаскируем" токен для rclone
          OBSCURED_TOKEN=$(rclone obscure "${{ secrets.YANDEX_DISK_TOKEN }}")

          # Создаем конфиг с замаскированным токеном
          cat > ~/.config/rclone/rclone.conf << EOF
          [yandex]
          type = webdav
          url = https://webdav.yandex.ru
          vendor = other
          user = oauth
          pass = ${OBSCURED_TOKEN}
          EOF

          echo "Config created with obscured token"

      - name: List remotes
        run: rclone listremotes

      - name: Create folder on Yandex Disk
        run: rclone mkdir yandex:/CineChanceTest || echo "Folder exists"

      - name: Create test file
        run: |
          echo "Test from GitHub Actions - $(date)" > test_file.txt
          echo "Timestamp: $(date +%Y%m%d_%H%M%S)" >> test_file.txt

      - name: Upload test file
        run: rclone copy test_file.txt yandex:/CineChanceTest/ -v

      - name: Verify upload
        run: rclone ls yandex:/CineChanceTest/
